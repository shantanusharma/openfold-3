name: Reusable Docker Test

on:
  # Can only be called by another workflow, not directly by the user
  workflow_call:
    inputs:
      build_mode:
        description: 'Build mode: "lock" for reproducible builds, "yaml" for flexible dev builds'
        required: true
        type: string
      cuda_base_image_tag:
        description: 'CUDA base image tag (e.g., 12.2.2-cudnn8-devel-ubuntu22.04)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/openfold3-docker

jobs:
  start-aws-runner:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      mapping: ${{ steps.aws-start.outputs.mapping }}
      instances: ${{ steps.aws-start.outputs.instances }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::203627415330:role/of-gha-runner
          aws-region: us-east-1
      - name: Create cloud runner
        id: aws-start
        uses: omsf/start-aws-gha-runner@v1.1.1
        with:
          aws_image_id: ami-0754c6e75b3b97dcd  # Deep Learning AMI Neuron (Ubuntu 22.04)
          aws_instance_type: t3.2xlarge
          aws_home_dir: /home/ubuntu
          aws_root_device_size: 200
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

  test-openfold-docker:
    runs-on: ${{ fromJSON(needs.start-aws-runner.outputs.instances) }}
    needs:
      - start-aws-runner
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v6
        with: 
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push test image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          target: test
          push: true
          build-args: |
            CUDA_BASE_IMAGE_TAG=${{ inputs.cuda_base_image_tag }}
            BUILD_MODE=${{ inputs.build_mode }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ inputs.cuda_base_image_tag }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-${{ inputs.cuda_base_image_tag }}
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:cache-${{ inputs.cuda_base_image_tag }},mode=max

      - name: Run unit tests
        run: |
          docker run \
            -v ${{ github.workspace }}:/opt/openfold3 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ inputs.cuda_base_image_tag }}-${{ github.sha }} \
            pytest openfold3/tests -vvv -n auto --cov=openfold3 --cov-report=xml --cov-report=term

      - name: Debug - List files and find coverage
        if: always()
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Files in workspace root ==="
          ls -la ${{ github.workspace }}
          echo "=== Looking for coverage files ==="
          find ${{ github.workspace }} -name "coverage.xml" -o -name ".coverage" 2>/dev/null || echo "No coverage files found"

      - name: Upload coverage report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-report-${{ inputs.build_mode }}-${{ inputs.cuda_base_image_tag }}
          path: |
            coverage.xml
            .coverage
          retention-days: 30

  stop-aws-runner:
    runs-on: ubuntu-latest
    permissions:
        id-token: write
        contents: read
    needs:
      - start-aws-runner
      - test-openfold-docker
    if: ${{ always() }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: arn:aws:iam::203627415330:role/of-gha-runner
          aws-region: us-east-1
      - name: Stop instances
        uses: omsf/stop-aws-gha-runner@v1.0.0
        with:
          instance_mapping: ${{ needs.start-aws-runner.outputs.mapping }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
